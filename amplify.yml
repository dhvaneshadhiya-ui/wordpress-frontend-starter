version: 1

# AWS Amplify Build Configuration
# Environment variables required in Amplify Console:
# - VITE_WORDPRESS_API_URL: https://dev.igeeksblog.com/wp-json/wp/v2
# - SITE_URL: https://wp.dev.igeeksblog.com
# - VITE_ENABLE_INDEXING: true (production) / false (staging)
# - USE_LOCAL_POSTS: true (use cached posts.json for faster builds)
# - PARTIAL_BUILD: true (enable partial rebuilds - only regenerate changed pages)

frontend:
  phases:
    preBuild:
      commands:
        - nvm use 22
        - npm ci
        # Note: Cache restore happens directly in prerender.js via getCachedFile()
        # No need to restore here - it would be overwritten by build:client anyway
    build:
      commands:
        # Fast SSG pipeline using cached content from GitHub Action
        - echo "Starting optimized SSG build..."
        
        # Step 1: Client build (skip on partial builds if cached)
        - |
          if [ "$PARTIAL_BUILD" = "true" ] && [ -d ".build-cache/assets" ] && [ -f ".build-cache/index.html" ]; then
            echo "PARTIAL BUILD: Restoring cached client bundle..."
            mkdir -p dist
            cp -r .build-cache/assets dist/
            cp .build-cache/index.html dist/
            [ -f ".build-cache/favicon.ico" ] && cp .build-cache/favicon.ico dist/
            [ -f ".build-cache/logo.png" ] && cp .build-cache/logo.png dist/
            echo "âœ“ Client bundle restored from cache (skipping Vite build)"
          else
            echo "FULL BUILD: Building fresh client bundle..."
            npm run build:client
          fi
        
        # Step 2: SSR build for prerendering
        - npm run build:server
        
        # Step 3: Pre-render routes (uses cached posts.json when USE_LOCAL_POSTS=true)
        # Set USE_LOCAL_POSTS=true in Amplify environment for fastest builds
        # Set PARTIAL_BUILD=true to only regenerate changed pages
        - node prerender.js
        
        # Step 4: Generate robots.txt based on VITE_ENABLE_INDEXING
        - node scripts/generate-robots.js
        
        # Step 5: Generate sitemap.xml from WordPress API
        - node scripts/generate-sitemap.js
        
        # Step 6: Save built files to cache for next partial build
        - node scripts/sync-build-cache.js save
        
        - echo "SSG build complete!"
  
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  
  cache:
    paths:
      - node_modules/**/*
      - .build-cache/**/*

# Custom headers for caching and security
customHeaders:
  - pattern: '**/*'
    headers:
      - key: X-Frame-Options
        value: DENY
      - key: X-Content-Type-Options
        value: nosniff
  
  - pattern: '*.html'
    headers:
      - key: Cache-Control
        value: 'public, max-age=0, must-revalidate'
  
  - pattern: '/assets/*'
    headers:
      - key: Cache-Control
        value: 'public, max-age=31536000, immutable'

# URL rewrites for clean URLs (mirrors Netlify _redirects logic)
customRules:
  # Category archives
  - source: '/category/<slug>'
    target: '/category/<slug>.html'
    status: '200'
  
  # Tag archives
  - source: '/tag/<slug>'
    target: '/tag/<slug>.html'
    status: '200'
  
  # Author archives
  - source: '/author/<slug>'
    target: '/author/<slug>.html'
    status: '200'
  
  # Post slugs (must be last before SPA fallback)
  - source: '/<slug>'
    target: '/<slug>.html'
    status: '200'
  
  # SPA fallback for unmatched routes
  - source: '/<*>'
    target: '/index.html'
    status: '200'
