version: 1

frontend:
  phases:
    preBuild:
      commands:
        - echo "=== Environment Check ==="
        - node --version
        - npm --version
        - npm install
    build:
      commands:
        - set -e
        - export VITE_WORDPRESS_API_URL=https://dev.igeeksblog.com/wp-json/wp/v2
        - export SITE_URL=https://dev.igeeksblog.com
        
        - echo "=== Step 1: Fetching WordPress content ==="
        - echo "Testing API connectivity..."
        - 'curl -s -f --connect-timeout 10 --max-time 30 "https://dev.igeeksblog.com/wp-json/wp/v2/posts?per_page=1" > /dev/null && echo "API reachable" || (echo "API unreachable" && exit 1)'
        - node scripts/fetch-wp-content.js || (echo "FAILED: fetch-wp-content.js" && exit 1)
        - ls -la src/data/
        - test -f src/data/posts.json || (echo "posts.json MISSING" && exit 1)
        - echo "Step 1 complete"
        
        - echo "=== Step 2: Building Vite application ==="
        - npx vite build || (echo "FAILED: vite build" && exit 1)
        - test -f dist/index.html || (echo "dist/index.html MISSING" && exit 1)
        - echo "Step 2 complete"
        
        - echo "=== Step 3: Generating static HTML with SEO ==="
        - node scripts/build-static.js || (echo "FAILED: build-static.js" && exit 1)
        - echo "Step 3 complete"
        
        - echo "=== Step 4: Generating sitemaps and robots.txt ==="
        - node scripts/generate-seo-files.js || (echo "FAILED: generate-seo-files.js" && exit 1)
        - echo "Step 4 complete"
        
        - echo "=== Build Verification ==="
        - find dist -name "index.html" | wc -l
        - ls -la dist/
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
